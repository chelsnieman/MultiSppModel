---
title: 'Q2: Hysteresis and Management'
author: "Colin Dassow and Chelsey Nieman"
date: "7/17/2020"
output: 
  word_document:
    fig_caption: true
bibliography: MultispeciesModelCite.bib

---

```{r setup, include=FALSE}
packages <- c("citr","bibtex","tidyverse","knitr","tinytex")

#some other packages and code to be used throughout the document
# Colin setting his working directory so he can source the function that holds the model we'll run. We could always set up a code chunk here to hold that instead of sourcing another script. setwd("C:/Users/jones/BoxSync/NDstuff/Dissertation/4/MultiSppModel")
library(deSolve)
library(ggpubr)
source("q2Func.R")
```

# Abstract

# Introduction  

Recreational angling has a major impact on the ecology of freshwater ecosystems and is likely to structure community dynamics through selective harvest of certain individuals and species from the system **(citation)**. In recognition of the impact anglers have on freshwater fish communities, ecosystem-based management, adaptive management, and safe operating spaces have all been invoked in an effort to better manage freshwater resources. A central theme of these strategies is a holistic view of the ecosystems we manage and a rejection of single species management strategies applied broadly in favor of flexibility that allows managers to consider the full context of the systems they work in and tailor their actions appropriately **(citation)**. 

Regime shifts are likely to have drastic impacts on aquatic systems and the recreational fisheries that rely on these systems. While increased resilience has been shown to decrease the likelihood of rapid shifts in the stable state of a system [@scheffer2001], many of these regime shifts are initiated by drivers that are not ecologically-driven. Current work to incorporate ecosystem-based management has focused on ecosystem change, such as climate change, and management strategies to maintain stable states of a system in light of ecosystem change [@liu2015]. However, some work has been done which focuses on other potential drivers of regime shifts. One driver of particular interest in fisheries is potential for harvest driven regime shifts[@steele1996; @rothschild2004].

Harvest driven regime shifts in fisheries have been studied in commercial and marine fisheries when ecosystem-based management has been implemented [@oken2016; @essington2015]. The recognition of the role interspecific interaction between species, and the hysteretic behavior that follows, has helped foster the adoption of ecosystem-based management [@walters2001; @blackwood2012]. @crowder2008 has explored the simultaneous impacts of multiple fished species on marine systems. This type of ecosystem-based management plays an import role in maintaining a desired stable state, often in the form of a specific fish community structure. This stands in contrast to more traditional management decisions which take a linear view of the system (e.g. fish population is over exploited so managers reduce mortality or stock in response). Instances where these simple solutions have had no effect, or even a negative effect, are abundant and demonstrate a need to consider alternative stable states and the hysteretic behavior that is often present in the complex aquatic communities we study [@pine2009]. One of the commonly hypothesized reasons for these counterintuitive responses to management actions was formalized as 'cultivation-depensation' effects by @walters2001. They describe how intraguild predation can lead to alternative, self-reinforcing, states that can be transitioned between through the intensity of harvest on the adults of the top predator species which is an intraguild predator with the forage fish species. Cultivation-depensation mechanisms have been empirically demonstrated in marine fisheries resulting in alternative stable states, thereby reducing the ability for recovery of some exploited species [@gardmark2015]. In freshwater systems however, there has been limited focus on the effects of harvesting multiple interacting species and the consequences it has for maintaining a desire stable state in the system. The hysteretic behaviors of many freshwater communities have, to date, focused on 'trophic triangle' models where a single harvested species is an intraguild predator with second species that is not part of the fishery, while in reality most freshwater systems are home to multiple harvested fish species which often interact with each other [@walters2001; @biggs2009]. 

We expand on a model presented in @biggs2009 and present here a two species, stage structured, fisheries model. In keeping with the tenets of ecosystem-based management our model moves away from a single harvested species management scenario and towards a more realistic system where multiple harvested sportfish species compete with each other. The outcome of this competition both affects and is affected by the effects of humans on the ecosystem through fishing activities (*I'm not sure if we want to limit this to just fishing or also thing about shoreline development, climate change as human effects too*). Adults and juveniles of both species compete with each other and are simultaneously harvested, but to different degrees. We parameterize this model to represent the largemouth bass (*Micropterus salmoides*) (*or should this be all centrarchids?*) and walleye (*Sander vitreus*) competitive interaction in north temperate lakes. This model is unique in that it looks at hysteresis and management in (1) a freshwater system, and (2) a multispecies system where both species are sport fish targeted by anglers. The goals of our modeling exercises are to (1) understand the role hysteresis plays in both the type and magnitude of management responses necessary to maintain a system in a desired configuration, and (2) to investigate the role management responses can play in reverting to an alternative configuration. We accomplish this by modeling species-specific responses to regulations and stocking in a system where hysteresis is present or absent. We perform those model experiments in systems where the manager's goal is to either maintain a desired stable state or push the system to a desired stable state from an undesired one. 

# Methods

## Base model

We used a stage structured, fishery model from @biggs2009. Their original model contained trophic triangle dynamics between a harvested sport fish with juvenile and adult stages, and a single stage planktivore fish that was not part of the fishery. The model also contains basic foraging arena dynamics where juvenile sportfish and planktivores move between the foraging arena and refuge. In this model adult sportfish can prey upon their own juveniles and planktivores when they are in the foraging arena. Planktivores can prey on juvenile sportfish in both the refuge and the foraging arena. Harvest rate and the amount of refuge available to fish are both externally controlled.

We modified this model by replacing the single stage planktivore with a second two-stage sport fish species. Adults of both species can predate on their own juveniles and juveniles of the opposite species when juveniles are present in the foraging arena. Juveniles of both species compete with each other for resources as well. Here too, harvest rate and the amount of refuge available to fish are both externally controlled. Our model is set up as a series of differential equations where adults are removed through catch and subsequent harvest ($-qE_1 A_1$) and natural mortality ($s_1-1$). New adults are produced by juveniles maturing at a constant rate($s_1J_1$). As an example we provide the equations for species 1 adults ($A_1$) and juveniles ($J_1$). The equations for species 2 are identical with reversed subscripts. 
$$\frac{dA_1}{dt} = -qE_1 A_1 + (s_1-1) A_1 + s_1J_1$$
$$\frac{dJ_1}{dt} = -c_{J_1,A_1} J_1 A_1 - c_{J_1,J_2} J_1 J_2 - \frac{c_{J_1,A_2}v_1 J_1 A_2}{h_1+v_1+c_{J_1,A_2}}+f_1A_1+\epsilon_1$$
The model displays hysteretic behavior typical of systems were competing species have limited more strongly by each other than by themselves. This manifests itself in what is typically called a 'priority effect' where the initial abundance is all the determines which species dominates. Here, the more abundant species is able to cultivate conditions for itself through predation on and competition with juveniles of the opposite species. The equilibrium abundances of the two competing species will depend on both the strength of harvest on each species and the strength of their effects on each other. When the species limit themselves more than they limit each other there is only one stable equilibrium point and hysteresis is gone from the system. 


## Simulations 
Simulations were run using the 'deSolve' package in R [@rcoreteam2020; @soetaert2010]. *then I'm guessing we want to say something about what parm values were used in the simulations and link to a table with them which will probably be supplemental info?* *I think we can make a table in rmd that will auto populate parameter values in the document iteself, also, if parameters arent variable, we might want it in the main document?*
*Here, I think we should list all the simulations we ran and say why - then just show the different oens in the results*

### Stocking
Stocking as included in our version of the @biggs2009 [2009] model through the term $+\epsilon$. This stocking takes the form of a yearly addition of a number juveniles to the system. 

### Management 
In our model managers can effect the system through setting harvest rate to a given level (*Note to us: this results in a proportion of the population removed each time step, at smaller pop size fewer fish are removed and vis versa*). This can be set as a constant level across time or can be allowed to vary between years. Similarly, stocking of juveniles by managers can be held constant through time or allowed to vary through time. A third management option which we do not address here is through improvements in refuge ($h$) availability leading to increased juvenile survival. 


# Results
## Base Model Behavior
*Discuss the base model and how it worked out for us*
Discuss, and maybe include a figure that show how the Biggs model is nested in our model and represents a species parameterization of our model. Our model is slightly more general/flexible because we allow for harvest on both species. *I can make a figure that shows how we can reproduce Bigg's results*

This model shows... (*Here I'm imagining a figure that shows how our version of the biggs model can, in it's most basic form, produce alternative stable states. *)

```{r, echo=FALSE, cash=TRUE, cash.comments=FALSE, fig.keep='high', fig.cap='Figure 1. Basic model behavior. When species are equal in all interactions, alternate stable states can be produced by through harvest. The stable state will depend  on the combination of harvest rate and the species with the higher initial abundance.'}
tstep=1:300
store=data.frame(qEs=seq(0,8,length.out=30),A1=0,A2=0,J1=0,J2=0)
y0=c(100,10,0,0)
for(i in 1:nrow(store)){
  qE1Fun=approxfun(x=tstep,y=c(rep(store$qEs[i],length(tstep))))
  qE2Fun=approxfun(x=tstep,y=rep(1.8,length(tstep)))
  h1Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
  h2Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  
  p=c(s1=0.1,cJ1A1=0.002,cJ1A2=0.5,cJ1J2=0.003,v1=1,f1=2,
      s2=0.1,cJ2A2=0.002,cJ2A1=0.5,cJ2J1=0.003,v2=1,f2=2)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  store$A1[i]=sim[nrow(sim)-1,2]
  store$A2[i]=sim[nrow(sim)-1,3]
  store$J1[i]=sim[nrow(sim)-1,4]
  store$J2[i]=sim[nrow(sim)-1,5]
}
store2=data.frame(qEs=seq(0,8,length.out=30),A1=0,A2=0,J1=0,J2=0)
y0=c(10,100,0,0)
for(i in 1:nrow(store2)){
  qE1Fun=approxfun(x=tstep,y=c(rep(store2$qEs[i],length(tstep))))
  qE2Fun=approxfun(x=tstep,y=rep(1.8,length(tstep)))
  h1Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
  h2Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  
  p=c(s1=0.1,cJ1A1=0.002,cJ1A2=0.5,cJ1J2=0.003,v1=1,f1=2,
      s2=0.1,cJ2A2=0.002,cJ2A1=0.5,cJ2J1=0.003,v2=1,f2=2)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  store2$A1[i]=sim[nrow(sim)-1,2]
  store2$A2[i]=sim[nrow(sim)-1,3]
  store2$J1[i]=sim[nrow(sim)-1,4]
  store2$J2[i]=sim[nrow(sim)-1,5]
}

plot(store$qEs,store$A1,lwd=3,type='l',ylim=c(0,max(store[,2:3],na.rm = T)),ylab = "Abundance",xlab = "Species 1 Harvest (q*E)")
lines(store$qEs,store$A2,lwd=3,col='grey')
lines(store2$qEs,store2$A1,lwd=3,lty=3)
lines(store2$qEs,store2$A2,lwd=3,col='grey',lty=3)
legend("topright",legend = c("sp 1", "sp 2","sp2>sp1","sp1>sp2"), col = c("black","grey","black","black"),lwd=2,lty = c(1,1,1,3),bty="n")


```


*here I think we can include this plot which looks at one run of the model through time to show how management intervention even one year too late can lead to a regime shift. Maybe this replaces the plot above where we run the model to euqilibrium across a range of parms values or maybe it's worth having both of these.*
```{r, echo=F,cache=T}
#### figure 1 ####

# mangement intervention in time
tstep=1:300
h1Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
h2Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
qE1Fun=approxfun(x=tstep,y=c(seq(0,by=.74,length.out = 94),rep(0,206)))
qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
st1Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
p=c(s1=0.1,cJ1A1=0.001,cJ1A2=0.5,cJ1J2=0.003,v1=1,f1=2,
    s2=0.1,cJ2A2=0.001,cJ2A1=0.3,cJ2J1=0.003,v2=1,f2=2)
y0=c(100,10,0,0)
sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)

#intervention one year later has no effect
qE1Fun=approxfun(x=tstep,y=c(seq(0,by=.74,length.out = 95),rep(0,205)))
sim2=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)

#plotting
par(mfcol=c(2,1), mar=c(1,1,1,1), oma=c(4,4,1,1))
plot(sim[,1],sim[,2],type='l',ylim=c(0,max(sim[,2:3],na.rm = T)),col='grey',lwd=2,xlab = "",ylab = "")
lines(sim[,1],sim[,3],col='black',lwd=2)
lines(sim[,1],qE1Fun(sim[,1]),lty=2)
text(x=225, y=100, labels = "94 years of harvest \nbefore intervention", cex=0.75)
legend("topleft", legend = c("sp1","sp2", "harvest rate"), col = c('grey','black','black'),lty = c(1,1,2),lwd=2,bty = "n")
plot(sim2[,1],sim2[,2],type='l',ylim=c(0,max(sim2[,2:3],na.rm = T)),col='grey',lwd=2,xlab = "",ylab = "")
lines(sim2[,1],sim2[,3],col='black',lwd=2)
lines(sim2[,1],qE1Fun(sim2[,1]),lty=2)
text(x=225, y=100, labels = "95 years of harvest \nbefore intervention", cex=0.75)
mtext("Year", side = 1, outer = T, line = 2.5)
mtext("Population Size", side = 2, outer = T, line = 2.5)
```

###Impact of stocking on system dynamics
   - optimal strategy and magnitude  
   - influence of hysteresis    
   
```{r,echo=FALSE, cache==TRUE, cache.comments=F, fig.cap="Figure 2. Effect of stocking at different harvest rates. (a) with hysteresis, (b) without hysteresis", eval=F}
#not sure exactly where we want this, in the simulation space or right in the results

#these get reused for both plots below
tstep=1:300
h1Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
h2Fun=approxfun(x=tstep,y=rep(8,length(tstep)))

#### OUTCOMES WITH HYSTERESIS ####
qEs=seq(0,8,length.out = 15)
sto=seq(0,200, length.out = 15)
df=expand.grid(X=qEs,Y=sto)
df$A1=numeric(nrow(df))
df$A2=numeric(nrow(df))
df$J1=numeric(nrow(df))
df$J2=numeric(nrow(df))

for(i in 1:nrow(df)){
  tstep=1:300
  qE1Fun=approxfun(x=tstep,y=rep(df$X[i], length(tstep)))
  qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(df$Y[i],length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  p=c(s1=0.1,cJ1A1=0.002,cJ1A2=0.5,cJ1J2=0.003,v1=1,f1=2,
      s2=0.1,cJ2A2=0.002,cJ2A1=0.003,cJ2J1=0.003,v2=1,f2=3)
  y0=c(10,10,0,0)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  df$A1[i]=sim[nrow(sim)-1,2]
  df$A2[i]=sim[nrow(sim)-1,3]
  df$J1[i]=sim[nrow(sim)-1,4]
  df$J2[i]=sim[nrow(sim)-1,5]
}

vz=ggplot(data = df)+theme_classic()
a=vz+geom_tile(aes(x=df$X, y=df$Y, fill=df$A1))+scale_fill_gradient(low ="blue", high = "yellow", name="")+
  labs(x="Harvest Rate", y="Stocked Fish per Year", title = "Hysteresis Present")+
   guides(fill="none")

#### OUTCOMES WITHOUT HYSTERESIS ####
qEs=seq(0,8,length.out = 15)
sto=seq(0,200, length.out = 15)
dfwo=expand.grid(X=qEs,Y=sto)
dfwo$A1=numeric(nrow(dfwo))
dfwo$A2=numeric(nrow(dfwo))
dfwo$J1=numeric(nrow(dfwo))
dfwo$J2=numeric(nrow(dfwo))

for(i in 1:nrow(dfwo)){
  tstep=1:300
  qE1Fun=approxfun(x=tstep,y=rep(dfwo$X[i], length(tstep)))
  qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(dfwo$Y[i],length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  p=c(s1=0.1,cJ1A1=0.002,cJ1A2=0,cJ1J2=0,v1=1,f1=2,
      s2=0.1,cJ2A2=0.002,cJ2A1=0,cJ2J1=0,v2=1,f2=2)
  y0=c(10,10,0,0)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  dfwo$A1[i]=sim[nrow(sim)-1,2]
  dfwo$A2[i]=sim[nrow(sim)-1,3]
  dfwo$J1[i]=sim[nrow(sim)-1,4]
  dfwo$J2[i]=sim[nrow(sim)-1,5]
}

vzwo=ggplot(data = dfwo)+theme_classic()
b=vzwo+geom_tile(aes(x=dfwo$X, y=dfwo$Y, fill=dfwo$A1))+
  scale_fill_gradient(low ="blue", high = "yellow", name="A1 Abund")+
  labs(x="Harvest Rate", y="", title = "No Hysteresis Present")

#comparing with and without hysteresis plots together 
ggarrange(a,b,labels = c("A","B"), nrow = 1,ncol = 2)
#this plot is a start at least, the point here is that when the species interact (hysteresis present) low levels of stocking at any harvest rate aren't enough to keep the system in a state where A1 dominates. (right now I'm using A1 abundance at my way of telling who dominates but it's not quite right I don't think. It'd be easy enough to pull different info out of the model runs if we wanted.)
```

```{r, cache=T, fig.dim=c(7,7), fig.cap="Fig X. Effect of hysteresis on either maintaining sp1 dominance (A &C) or flipping to a state where sp 1 dominates (B &D). This is described for systems with and without hysteresis. Green = sp1 equilibrium abundance higher than sp2, red = sp2 > sp1}
##### HEATMAPS #####

  ##### MAINTAIN W/ HYST. ####
#matrix to hold output, starting with different harvest levels on each species
tstep=1:300
h1Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
h2Fun=approxfun(x=tstep,y=rep(8,length(tstep)))

qEs=seq(0,8,length.out = 15)
sto=seq(0,200, length.out = 15)
df=expand.grid(X=qEs,Y=sto)
df$A1=numeric(nrow(df))
df$A2=numeric(nrow(df))
df$J1=numeric(nrow(df))
df$J2=numeric(nrow(df))


for(i in 1:nrow(df)){
  tstep=1:300
  qE1Fun=approxfun(x=tstep,y=rep(df$X[i], length(tstep)))
  qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(df$Y[i],length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  p=c(s1=0.1,cJ1A1=0.002,cJ1A2=0.5,cJ1J2=0.003,v1=1,f1=2,
      s2=0.1,cJ2A2=0.002,cJ2A1=0.003,cJ2J1=0.003,v2=1,f2=3)
  y0=c(100,10,0,0)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  df$A1[i]=sim[nrow(sim)-1,2]
  df$A2[i]=sim[nrow(sim)-1,3]
  df$J1[i]=sim[nrow(sim)-1,4]
  df$J2[i]=sim[nrow(sim)-1,5]
}

df$outcome=ifelse(df$A1>=df$A2,"darkgreen", "darkred")
vz=ggplot(data = df)+theme_classic()

a=vz+geom_tile(aes(x=df$X, y=df$Y), fill=df$outcome)+
  labs(x="Harvest Rate", y="Stocked fish", title = "Hysteresis Present")

#### FLIP W/ HYST. ####

qEs=seq(0,8,length.out = 15)
sto=seq(0,200, length.out = 15)
df2=expand.grid(X=qEs,Y=sto)
df2$A1=numeric(nrow(df2))
df2$A2=numeric(nrow(df2))
df2$J1=numeric(nrow(df2))
df2$J2=numeric(nrow(df2))


for(i in 1:nrow(df)){
  tstep=1:300
  qE1Fun=approxfun(x=tstep,y=rep(df2$X[i], length(tstep)))
  qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(df2$Y[i],length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  p=c(s1=0.1,cJ1A1=0.002,cJ1A2=0.5,cJ1J2=0.003,v1=1,f1=2,
      s2=0.1,cJ2A2=0.002,cJ2A1=0.003,cJ2J1=0.003,v2=1,f2=3)
  y0=c(10,100,0,0)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  df2$A1[i]=sim[nrow(sim)-1,2]
  df2$A2[i]=sim[nrow(sim)-1,3]
  df2$J1[i]=sim[nrow(sim)-1,4]
  df2$J2[i]=sim[nrow(sim)-1,5]
}

df2$outcome=ifelse(df2$A1>=df2$A2,"darkgreen", "darkred")
vz=ggplot(data = df2)+theme_classic()
b=vz+geom_tile(aes(x=df2$X, y=df2$Y), fill=df2$outcome)+
  labs(x="Harvest Rate", y="Stocked fish", title = "Hysteresis Present")

##### MAINTAIN W/O HYST. ####
#matrix to hold output, starting with different harvest levels on each species

qEs=seq(0,8,length.out = 15)
sto=seq(0,200, length.out = 15)
dfwo=expand.grid(X=qEs,Y=sto)
dfwo$A1=numeric(nrow(dfwo))
dfwo$A2=numeric(nrow(dfwo))
dfwo$J1=numeric(nrow(dfwo))
dfwo$J2=numeric(nrow(dfwo))

for(i in 1:nrow(dfwo)){
  tstep=1:300
  qE1Fun=approxfun(x=tstep,y=rep(dfwo$X[i], length(tstep)))
  qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(dfwo$Y[i],length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  p=c(s1=0.1,cJ1A1=0.004,cJ1A2=0.001,cJ1J2=0.001,v1=1,f1=2,
      s2=0.1,cJ2A2=0.004,cJ2A1=0.001,cJ2J1=0.001,v2=1,f2=2)
  y0=c(100,10,0,0)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  dfwo$A1[i]=sim[nrow(sim)-1,2]
  dfwo$A2[i]=sim[nrow(sim)-1,3]
  dfwo$J1[i]=sim[nrow(sim)-1,4]
  dfwo$J2[i]=sim[nrow(sim)-1,5]
}

dfwo$outcome=ifelse(dfwo$A1>=dfwo$A2, "darkgreen", "darkred")
vzwo=ggplot(data = dfwo)+theme_classic()
c=vzwo+geom_tile(aes(x=dfwo$X, y=dfwo$Y), fill=dfwo$outcome)+
  scale_fill_gradient(low ="blue", high = "yellow", name="")+
  labs(x="Harvest Rate", y="Stocked fish", title = "No Hysteresis Present")

#### FLIP W/O HYST. ####

qEs=seq(0,8,length.out = 15)
sto=seq(0,200, length.out = 15)
dfwo2=expand.grid(X=qEs,Y=sto)
dfwo2$A1=numeric(nrow(dfwo2))
dfwo2$A2=numeric(nrow(dfwo2))
dfwo2$J1=numeric(nrow(dfwo2))
dfwo2$J2=numeric(nrow(dfwo2))


for(i in 1:nrow(dfwo2)){
  tstep=1:300
  qE1Fun=approxfun(x=tstep,y=rep(dfwo2$X[i], length(tstep)))
  qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
  st1Fun=approxfun(x=tstep,y=rep(dfwo2$Y[i],length(tstep)))
  st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
  p=c(s1=0.1,cJ1A1=0.004,cJ1A2=0.001,cJ1J2=0.001,v1=1,f1=2,
      s2=0.1,cJ2A2=0.004,cJ2A1=0.001,cJ2J1=0.001,v2=1,f2=2)
  y0=c(10,100,0,0)
  sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
  dfwo2$A1[i]=sim[nrow(sim)-1,2]
  dfwo2$A2[i]=sim[nrow(sim)-1,3]
  dfwo2$J1[i]=sim[nrow(sim)-1,4]
  dfwo2$J2[i]=sim[nrow(sim)-1,5]
}

dfwo2$outcome=ifelse(dfwo2$A1>=dfwo2$A2, "darkgreen", "darkred")
vzwo=ggplot(data = dfwo2)+theme_classic()
d=vzwo+geom_tile(aes(x=dfwo2$X, y=dfwo2$Y), fill=dfwo2$outcome)+
  scale_fill_gradient(low ="blue", high = "yellow", name="")+
  labs(x="Harvest Rate", y="Stocked fish", title = "No Hysteresis Present")

#comparing with and without hysteresis plots together using cowplot package
ggarrange(a,b,c,d,labels = c("A","B","C","D"), nrow = 2,ncol = 2, common.legend = T, legend = 'bottom')

```
###Impact of Managment on system dyanmics  
   - optimal strategy and magnitude  
   - influence of hysteresis    
   
````{r, echo=FALSE, cash=TRUE, cash.comments=F, fig.cap='Figure 3. dynamics through time'}

#another panel plot that focuses on dynamics through time (instead of equilibrium) similar to Biggs
#### WITH HYSTERESIS and a state flip
tstep=1:300
h1Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
h2Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
qE1Fun=approxfun(x=tstep,y=c(seq(0,by=.74,length.out = 100),rep(0,200)))
qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
st1Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
p=c(s1=0.1,cJ1A1=0.001,cJ1A2=0.5,cJ1J2=0.003,v1=1,f1=2,
    s2=0.1,cJ2A2=0.001,cJ2A1=0.3,cJ2J1=0.003,v2=1,f2=2)
y0=c(100,10,0,0)
sim=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)

# with hysteresis and not state flip
qE1Fun=approxfun(x=tstep,y=c(seq(0,by=.73,length.out = 100),rep(0,200)))
sim2=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)

#### WITHOUT HYSTERESIS and harv that should flip states (rate matches that above)
tstep=1:300
h1Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
h2Fun=approxfun(x=tstep,y=rep(8,length(tstep)))
qE1Fun=approxfun(x=tstep,y=c(seq(0,by=.74,length.out = 100),rep(0,200)))
qE2Fun=approxfun(x=tstep,y=rep(0, length(tstep)))
st1Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
st2Fun=approxfun(x=tstep,y=rep(0,length(tstep)))
p=c(s1=0.1,cJ1A1=0.004,cJ1A2=0.001,cJ1J2=0.001,v1=1,f1=2,
    s2=0.1,cJ2A2=0.004,cJ2A1=0.001,cJ2J1=0.001,v2=1,f2=2)
y0=c(100,10,0,0)

#without hysteresis and a harvest level that shouldn't flip states (matching w/ hyst. model above)
qE1Fun=approxfun(x=tstep,y=c(seq(0,by=.73,length.out = 100),rep(0,200)))
sim4=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)

#plot shows top
par(mfrow=c(2,2))
plot(sim[,1],sim[,2],type='l',ylim=c(0,max(sim[,2:3],na.rm = T)),col='grey',lwd=2,xlab = "Year",ylab = "pop. size")
lines(sim[,1],sim[,3],col='black',lwd=2)
lines(sim[,1],qE1Fun(sim[,1]),lty=2)
legend("topleft", legend = c("sp1","sp2"), col = c('grey','black'),lty = 1,lwd=2,bty = "n")
plot(sim2[,1],sim2[,2],type='l',ylim=c(0,max(sim2[,2:3],na.rm = T)),col='grey',lwd=2,xlab = "Year",ylab = "pop. size")
lines(sim2[,1],sim2[,3],col='black',lwd=2)
lines(sim2[,1],qE1Fun(sim2[,1]),lty=2)
legend("topleft", legend = c("sp1","sp2"), col = c('grey','black'),lty = 1,lwd=2,bty = "n")
sim3=ode(y=y0,times=tstep,func=simBiggsQ2,parms=p)
plot(sim3[,1],sim3[,2],type='l',ylim=c(0,max(sim3[,2:3],na.rm = T)),col='grey',lwd=2,xlab = "Year",ylab = "pop. size")
lines(sim3[,1],sim3[,3],col='black',lwd=2)
lines(sim3[,1],qE1Fun(sim3[,1]),lty=2)
legend("topleft", legend = c("sp1","sp2"), col = c('grey','black'),lty = 1,lwd=2,bty = "n")
plot(sim4[,1],sim4[,2],type='l',ylim=c(0,max(sim4[,2:3],na.rm = T)),col='grey',lwd=2,xlab = "Year",ylab = "pop. size")
lines(sim4[,1],sim4[,3],col='black',lwd=2)
lines(sim4[,1],qE1Fun(sim4[,1]),lty=2)
legend("topleft", legend = c("sp1","sp2"), col = c('grey','black'),lty = 1,lwd=2,bty = "n")

````

# Discussion
Impact of hysteresis in our model  
extrapolate to freshwater fish dynamics  
   - How our model is/is not a good representation of freshwater systems  
   -What is missing from our model.   
Optimal Management Strategies   
  - What did we learn from comparing stocking and controlling harvest?  
  - Management implications - do we use models like this to identify 'Early Warning Signs' of potential regime shift? [@litzow2016].   
How can this be used by managers  
  - Strategies for maintaining a desired stable state  
Future work   
  - Ground truth this model with empirical data   
  - Think about how angler dynamics can impact fisheries outcomes   
*I'm just adding these to show that the need to understand these is there (and to put a plug for our other two papers)*  
Conclusions

# References

